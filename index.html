<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liste des Recteurs et Rectrices</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            max-width: 1280px;
            margin: 2rem auto;
            padding: 0 1rem;
            color: #333;
            line-height: 1.6;
        }

        h1 {
            margin-bottom: 0.5rem;
            color: #2c3e50;
            text-align: center;
        }

        /* Style pour le sous-titre de mise √† jour */
        #last-update {
            color: #666;
            font-style: italic;
            margin-top: 5px;
            margin-bottom: 0;
            font-size: 0.85rem;
            text-align: center;
        }

        table {
            width: fit-content;
            margin: 1rem auto;
            border-collapse: collapse;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
            /* Pour les coins arrondis */
        }

        th,
        td {
            border-bottom: 1px solid #eee;
            padding: 8px 10px;
            text-align: left;
            white-space: nowrap;
            font-size: 0.9rem;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #444;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.05em;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:nth-child(even) {
            background-color: #fafafa;
        }

        tr:hover {
            background-color: #f1f8ff;
        }

        a {
            color: #0366d6;
            text-decoration: none;
            font-weight: 500;
        }

        a:hover {
            text-decoration: underline;
        }

        .error-text {
            color: #d73a49;
            font-size: 0.9em;
            background-color: #ffeef0;
            border-radius: 4px;
            padding: 2px 6px;
        }

        /* Responsive pour mobile */
        @media (max-width: 600px) {

            body {
                padding: 0 0.5rem;
                margin: 1rem auto;
            }

            table {
                width: 100%;
                box-shadow: none;
                border-radius: 0;
            }

            table,
            thead,
            tbody,
            th,
            td,
            tr {
                display: block;
            }

            thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }

            tr {
                margin-bottom: 1rem;
                border: 1px solid #ddd;
                border-radius: 8px;
                box-shadow: 0 1px 3px rgba(0,0,0,0.07);
                width: 100%;
            }

            td {
                border: none;
                position: relative;
                padding: 8px 12px 8px 42%;
                white-space: normal;
                word-break: break-word;
            }

            td:before {
                position: absolute;
                top: 10px;
                left: 12px;
                width: 38%;
                padding-right: 8px;
                white-space: nowrap;
                font-weight: bold;
                color: #999;
            }

            td:nth-of-type(1):before {
                content: "Acad√©mie";
            }

            td:nth-of-type(2):before {
                content: "Genre";
            }

            td:nth-of-type(3):before {
                content: "Nom";
            }

            td:nth-of-type(4):before {
                content: "Adresse";
            }

            td:nth-of-type(5):before {
                content: "T√©l√©phone";
            }

            td:nth-of-type(6):before {
                content: "Email";
            }

            td:nth-of-type(7):before {
                content: "Mise √† jour";
            }

            td:nth-of-type(8):before {
                content: "Historique";
            }

            /* Hide the history cell entirely when it has no button */
            td.hist-empty {
                display: none;
            }

            /* History detail row: reset the forced left-padding and kill the pseudo-label */
            tr.hist-detail td {
                padding-left: 1rem;
                padding-right: 1rem;
            }
            tr.hist-detail td::before {
                display: none;
            }
        }

        /* History toggle button */
        .hist-btn {
            background: none;
            border: 1px solid #c8d8e8;
            border-radius: 4px;
            color: #0366d6;
            cursor: pointer;
            font-size: 0.8rem;
            padding: 2px 6px;
            white-space: nowrap;
        }
        .hist-btn:hover {
            background-color: #f1f8ff;
        }
        .hist-btn.active {
            background-color: #e8f4ff;
            border-color: #0366d6;
        }

        /* History detail row */
        tr.hist-detail td {
            background-color: #f8fbff;
            border-top: none;
            padding: 0.6rem 1.2rem 0.8rem 2.5rem;
        }

        /* History timeline list */
        .hist-list {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .hist-list li {
            font-size: 0.85rem;
            color: #444;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }
        .hist-list li::before {
            content: "‚Üí";
            color: #aaa;
            flex-shrink: 0;
        }
        .hist-list li:first-child::before {
            content: "‚òÖ";
            color: #f0a030;
        }
        .hist-since {
            color: #888;
            font-size: 0.8rem;
        }
        .hist-badge-current {
            background: #e6f4ea;
            color: #1a7f37;
            border-radius: 3px;
            font-size: 0.75rem;
            padding: 1px 5px;
        }
    </style>
</head>

<body>
    <h1>üéì Recteurs et Rectrices d'Acad√©mie</h1>

    <table id="rectors-table">
        <thead>
            <tr>
                <th>Acad√©mie</th>
                <th>Genre</th>
                <th>Nom</th>
                <th>Adresse</th>
                <th>T√©l√©phone</th>
                <th>Email</th>
                <th>Mise √† jour</th>
                <th>Historique</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td colspan="5" style="text-align:center; color:#888; padding: 2rem;">Chargement des donn√©es en cours...
                </td>
            </tr>
        </tbody>
    </table>

    <p id="last-update">Chargement de la date de mise √† jour...</p>

    <script>
        // Mapping des emails (hardcoded)
        const emailMapping = {
            "Aix-Marseille": "ce.rectorat@ac-aix-marseille.fr",
            "Amiens": "ce.rectorat@ac-amiens.fr",
            "Besan√ßon": "ce.rectorat@ac-besancon.fr",
            "Bordeaux": "ce.rectorat@ac-bordeaux.fr",
            "Clermont-Ferrand": "ce.rectorat@ac-clermont.fr",
            "Corse": "ce.rectorat@ac-corse.fr",
            "Cr√©teil": "ce.rectorat@ac-creteil.fr",
            "Dijon": "ce.rectorat@ac-dijon.fr",
            "Grenoble": "ce.rectorat@ac-grenoble.fr",
            "Guadeloupe": "ce.rectorat@ac-guadeloupe.fr",
            "Guyane": "ce.rectorat@ac-guyane.fr",
            "La R√©union": "ce.rectorat@ac-reunion.fr",
            "Lille": "ce.rectorat@ac-lille.fr",
            "Limoges": "ce.rectorat@ac-limoges.fr",
            "Lyon": "ce.rectorat@ac-lyon.fr",
            "Martinique": "ce.rectorat@ac-martinique.fr",
            "Mayotte": "ce.rectorat@ac-mayotte.fr",
            "Montpellier": "ce.rectorat@ac-montpellier.fr",
            "Nancy-Metz": "ce.rectorat@ac-nancy-metz.fr",
            "Nantes": "ce.rectorat@ac-nantes.fr",
            "Nice": "ce.rectorat@ac-nice.fr",
            "Normandie": "ce.rectorat@ac-normandie.fr",
            "Nouvelle-Cal√©donie": "ce.rectorat@ac-noumea.nc",
            "Orl√©ans-Tours": "ce.rectorat@ac-orleans-tours.fr",
            "Paris": "ce.rectorat@ac-paris.fr",
            "Poitiers": "ce.rectorat@ac-poitiers.fr",
            "Polyn√©sie fran√ßaise": "accueil@ac-polynesie.pf",
            "Reims": "ce.rectorat@ac-reims.fr",
            "Rennes": "ce.rectorat@ac-rennes.fr",
            "Saint-Pierre-et-Miquelon": "ia@ac-spm.fr",
            "Strasbourg": "ce.rectorat@ac-strasbourg.fr",
            "Toulouse": "ce.rectorat@ac-toulouse.fr",
            "Versailles": "ce.rectorat@ac-versailles.fr",
            "Wallis-et-Futuna": "ce.rectorat@ac-wf.wf"
        };

        /**
         * Toggle the history detail row for a given academy.
         */
        function toggleHistory(acad, entries, refRow, btn) {
            const existingDetail = document.querySelector(`tr.hist-detail[data-acad="${CSS.escape(acad)}"]`);
            if (existingDetail) {
                existingDetail.remove();
                btn.classList.remove('active');
                return;
            }

            btn.classList.add('active');

            const detailRow = document.createElement('tr');
            detailRow.className = 'hist-detail';
            detailRow.dataset.acad = acad;

            const td = document.createElement('td');
            td.colSpan = 8;

            // Build the timeline list (newest first)
            const list = document.createElement('ol');
            list.className = 'hist-list';

            [...entries].reverse().forEach((entry, idx) => {
                const li = document.createElement('li');
                const sinceDate = new Date(entry.since + 'T00:00:00').toLocaleDateString('fr-FR', {
                    day: 'numeric', month: 'long', year: 'numeric'
                });
                const currentBadge = idx === 0
                    ? ' <span class="hist-badge-current">en poste</span>'
                    : '';
                li.innerHTML = `<strong>${entry.genre} ${entry.nom}</strong>`
                    + ` <span class="hist-since">depuis le ${sinceDate}</span>`
                    + currentBadge;
                list.appendChild(li);
            });

            td.appendChild(list);
            detailRow.appendChild(td);
            refRow.after(detailRow);
        }

        Promise.all([
            fetch('recteurs.json').then(r => r.json()),
            fetch('history.json').then(r => r.json()).catch(() => ({}))
        ])
        .then(([data, history]) => {
            const tbody = document.querySelector('#rectors-table tbody');
            const updateText = document.querySelector('#last-update');

            // 1. Gestion de la date de mise √† jour
            if (data.length > 0 && data[0].updated_at) {
                const rawDate = new Date(data[0].updated_at);
                const formattedDate = rawDate.toLocaleDateString('fr-FR', {
                    weekday: 'long',
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric'
                });
                const finalDate = formattedDate.charAt(0).toUpperCase() + formattedDate.slice(1);
                updateText.innerText = `Mise √† jour quotidienne automatique (Derni√®re ex√©cution : ${finalDate})`;
            } else {
                updateText.innerText = "Mise √† jour quotidienne automatique.";
            }

            // 2. Remplissage du tableau
            tbody.innerHTML = '';

            data.forEach(row => {
                const tr = document.createElement('tr');

                // Clean academy name (remove parenthetical suffixes)
                const cleanAcademieName = row.academie.replace(/\s*\(.*?\)/g, '').trim();

                // Format update date
                let dateStr = '';
                if (row.updated_at) {
                    const d = new Date(row.updated_at);
                    dateStr = d.toLocaleDateString('fr-FR');
                }

                const acadHistory = history[row.academie] || [];
                const hasHistory = acadHistory.length > 1;

                if (row.error) {
                    tr.innerHTML = `
                        <td><a href="${row.url}" target="_blank">${cleanAcademieName}</a></td>
                        <td colspan="7"><span class="error-text">‚ö†Ô∏è ${row.error} (V√©rifier manuellement)</span></td>
                    `;
                } else {
                    const email = emailMapping[row.academie] || '-';

                    tr.innerHTML = `
                        <td><a href="${row.url}" target="_blank">${cleanAcademieName}</a></td>
                        <td>${row.genre}</td>
                        <td><strong>${row.nom}</strong></td>
                        <td>${row.adresse || '-'}</td>
                        <td>${row.telephone && row.telephone !== '-' ? `<a href="tel:${row.telephone.replace(/\s/g, '')}" title="${row.telephone}">üìû</a>` : '-'}</td>
                        <td>${email !== '-' ? `<a href="mailto:${email}" title="${email}">‚úâÔ∏è</a>` : '-'}</td>
                        <td style="color: #666; font-size: 0.9em;">${dateStr}</td>
                        <td class="hist-empty"></td>
                    `;

                    // Add history button if there are at least 2 entries
                    if (hasHistory) {
                        const histCell = tr.lastElementChild;
                        histCell.classList.remove('hist-empty');
                        const btn = document.createElement('button');
                        btn.className = 'hist-btn';
                        btn.title = 'Voir l\'historique des recteurs';
                        btn.textContent = `üìú ${acadHistory.length}`;
                        btn.addEventListener('click', () => toggleHistory(row.academie, acadHistory, tr, btn));
                        histCell.appendChild(btn);
                    }
                }

                tbody.appendChild(tr);
            });
        })
        .catch(err => {
            console.error(err);
            document.querySelector('#rectors-table tbody').innerHTML =
                `<tr><td colspan="8" style="color:#d73a49; text-align:center; padding:2rem;">
                    <strong>Erreur lors du chargement des donn√©es.</strong><br>
                    V√©rifiez que les fichiers recteurs.json et history.json ont bien √©t√© g√©n√©r√©s.
                </td></tr>`;
        });
    </script>
</body>


</html>
