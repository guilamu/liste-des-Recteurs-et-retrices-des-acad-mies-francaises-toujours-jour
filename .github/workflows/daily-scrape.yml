name: Update Rectors Data

on:
  schedule:
    # 3 tentatives espac√©es d'1h ‚Äî seule la derni√®re (08h) notifie en cas d'√©chec
    - cron: '0 6 * * *'   # Tentative 1
    - cron: '0 7 * * *'   # Tentative 2 (si T1 √©chou√©e)
    - cron: '0 8 * * *'   # Tentative 3 (si T1+T2 √©chou√©es) ‚Üí notification
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  scrape:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # ‚îÄ‚îÄ‚îÄ Skip si d√©j√† r√©ussi aujourd'hui (√©vite les runs inutiles √† 07h/08h) ‚îÄ‚îÄ
      - name: "üîé V√©rifier si d√©j√† r√©ussi aujourd'hui"
        id: check_skip
        if: github.event_name == 'schedule'
        run: |
          TODAY=$(date -u +%Y-%m-%d)
          if [ -f .last-scrape-success ] && [ "$(cat .last-scrape-success)" = "$TODAY" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Scraping d√©j√† r√©ussi aujourd'hui, on passe."
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "üîÑ Pas de succ√®s aujourd'hui, lancement du scraping."
          fi

      # ‚îÄ‚îÄ‚îÄ D√©terminer si c'est la derni√®re tentative (= doit notifier si √©chec) ‚îÄ‚îÄ
      - name: "üìã D√©terminer le num√©ro de tentative"
        id: attempt_info
        if: steps.check_skip.outputs.skip != 'true'
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "is_last=true" >> $GITHUB_OUTPUT
            echo "üìã Lancement manuel ‚Üí notification en cas d'√©chec"
          else
            HOUR=$(date -u +%-H)
            if [ "$HOUR" -ge 8 ]; then
              echo "is_last=true" >> $GITHUB_OUTPUT
              echo "üìã Tentative 3/3 (derni√®re) ‚Üí notification en cas d'√©chec"
            else
              echo "is_last=false" >> $GITHUB_OUTPUT
              echo "üìã Tentative interm√©diaire (heure=$HOUR) ‚Üí retry silencieux si √©chec"
            fi
          fi

      - name: Setup Node.js
        if: steps.check_skip.outputs.skip != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        if: steps.check_skip.outputs.skip != 'true'
        run: npm install

      - name: Setup SSH keys
        if: steps.check_skip.outputs.skip != 'true'
        env:
          PROXY_DEBIAN_KEY: ${{ secrets.PROXY_DEBIAN_KEY }}
          PROXY_WIN_KEY: ${{ secrets.PROXY_WIN_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$PROXY_DEBIAN_KEY" > ~/.ssh/proxy_debian
          echo "$PROXY_WIN_KEY"   > ~/.ssh/proxy_win
          chmod 600 ~/.ssh/proxy_debian ~/.ssh/proxy_win

      # ‚îÄ‚îÄ‚îÄ Tentative 1 : Direct (pas de proxy) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "üü¢ Tentative 1 : Scraping direct (GitHub IP)"
        id: try_direct
        if: steps.check_skip.outputs.skip != 'true'
        run: node scraper.js
        continue-on-error: true

      # ‚îÄ‚îÄ‚îÄ Tentative 2 : Proxy Debian ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "üü° Setup proxy Debian"
        if: steps.check_skip.outputs.skip != 'true' && steps.try_direct.outcome == 'failure'
        env:
          PROXY_DEBIAN_HOST: ${{ secrets.PROXY_DEBIAN_HOST }}
          PROXY_DEBIAN_USER: ${{ secrets.PROXY_DEBIAN_USER }}
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/proxy_debian \
              -D 1080 -N -f \
              $PROXY_DEBIAN_USER@$PROXY_DEBIAN_HOST
          echo "PROXY_URL=socks5://localhost:1080" >> $GITHUB_ENV
          echo "‚úÖ Tunnel SOCKS5 Debian actif"

      - name: "üü° Tentative 2 : Scraping via proxy Debian"
        id: try_debian
        if: steps.check_skip.outputs.skip != 'true' && steps.try_direct.outcome == 'failure'
        env:
          PUPPETEER_PROXY: ${{ env.PROXY_URL }}
        run: node scraper.js
        continue-on-error: true

      - name: Kill tunnel Debian
        if: steps.check_skip.outputs.skip != 'true' && steps.try_direct.outcome == 'failure'
        run: pkill -f "ssh.*1080" || true

      # ‚îÄ‚îÄ‚îÄ Tentative 3 : Proxy Windows home ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "üî¥ Setup proxy Windows home"
        if: steps.check_skip.outputs.skip != 'true' && steps.try_direct.outcome == 'failure' && steps.try_debian.outcome == 'failure'
        env:
          PROXY_WIN_HOST: ${{ secrets.PROXY_WIN_HOST }}
          PROXY_WIN_USER: ${{ secrets.PROXY_WIN_USER }}
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/proxy_win \
              -D 1081 -N -f \
              $PROXY_WIN_USER@$PROXY_WIN_HOST
          echo "PROXY_URL=socks5://localhost:1081" >> $GITHUB_ENV
          echo "‚úÖ Tunnel SOCKS5 Windows home actif"

      - name: "üî¥ Tentative 3 : Scraping via proxy Windows home"
        id: try_win
        if: steps.check_skip.outputs.skip != 'true' && steps.try_direct.outcome == 'failure' && steps.try_debian.outcome == 'failure'
        env:
          PUPPETEER_PROXY: ${{ env.PROXY_URL }}
        run: node scraper.js
        continue-on-error: true

      - name: Kill tunnel Windows
        if: steps.check_skip.outputs.skip != 'true' && steps.try_direct.outcome == 'failure' && steps.try_debian.outcome == 'failure'
        run: pkill -f "ssh.*1081" || true

      # ‚îÄ‚îÄ‚îÄ √âvaluer le r√©sultat global des 3 proxies ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "üìä R√©sultat des tentatives proxy"
        id: result
        if: steps.check_skip.outputs.skip != 'true'
        run: |
          if [ "${{ steps.try_direct.outcome }}" = "success" ] || \
             [ "${{ steps.try_debian.outcome }}" = "success" ] || \
             [ "${{ steps.try_win.outcome }}" = "success" ]; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Au moins une tentative proxy a r√©ussi"
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "‚ùå Les 3 proxies ont √©chou√© pour ce run"
          fi

      # ‚îÄ‚îÄ‚îÄ Succ√®s : commit + marquer le jour comme r√©ussi ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "‚úÖ Commit results & mark success"
        if: steps.result.outputs.success == 'true'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          date -u +%Y-%m-%d > .last-scrape-success
          git add recteurs.json history.json .last-scrape-success
          git commit -m "Update rectors data" || echo "No changes"
          git push

      # ‚îÄ‚îÄ‚îÄ √âchec interm√©diaire : log silencieux, on retente dans ~1h ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "‚è≥ √âchec interm√©diaire ‚Äî retry dans ~1h"
        if: steps.result.outputs.success == 'false' && steps.attempt_info.outputs.is_last != 'true'
        run: |
          echo "::warning::Scraping √©chou√© (3 proxies). Nouvelle tentative automatique dans ~1 heure."
          echo "Pas de notification envoy√©e."

      # ‚îÄ‚îÄ‚îÄ √âchec final (3 runs √ó 3 proxies) : notification ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Create issue on final failure
        if: steps.result.outputs.success == 'false' && steps.attempt_info.outputs.is_last == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let errorDetails = '';
            
            try {
              const errors = JSON.parse(fs.readFileSync('scraper-errors.json', 'utf8'));
              errorDetails = `\n\n**${errors.count} acad√©mie(s) en √©chec :**\n` +
                errors.academies.map(a => `- ${a}`).join('\n');
            } catch (e) {
              errorDetails = '\n\nD√©tails des erreurs non disponibles.';
            }
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `‚ùå √âchec du scraping (3 runs √ó 3 proxies) - ${new Date().toLocaleDateString('fr-FR')}`,
              body: `Le scraping des donn√©es des recteurs a √©chou√© malgr√© **3 tentatives espac√©es d'1 heure**, chacune avec 3 proxies (direct, Debian, Windows).\n\nSoit **9 essais au total** sans succ√®s.${errorDetails}\n\n**Workflow Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              labels: ['scraper-error', 'automated']
            });

      - name: "üíÄ √âchec final"
        if: steps.result.outputs.success == 'false' && steps.attempt_info.outputs.is_last == 'true'
        run: |
          echo "‚ùå 3 runs espac√©s d'1h ont tous √©chou√© (3 proxies chacun = 9 essais)."
          exit 1
