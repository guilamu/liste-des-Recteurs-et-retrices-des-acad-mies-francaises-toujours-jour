name: Update Rectors Data

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  scrape:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'  # ‚Üê Changez de '18' √† '20'
      
      - name: Install dependencies
        run: npm install

      - name: Setup SSH keys
        env:
          PROXY_DEBIAN_KEY: ${{ secrets.PROXY_DEBIAN_KEY }}
          PROXY_WIN_KEY: ${{ secrets.PROXY_WIN_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$PROXY_DEBIAN_KEY" > ~/.ssh/proxy_debian
          echo "$PROXY_WIN_KEY"   > ~/.ssh/proxy_win
          chmod 600 ~/.ssh/proxy_debian ~/.ssh/proxy_win

      # ‚îÄ‚îÄ‚îÄ Tentative 1 : Direct (pas de proxy) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "üü¢ Tentative 1 : Scraping direct (GitHub IP)"
        id: try_direct
        run: node scraper.js
        continue-on-error: true

      # ‚îÄ‚îÄ‚îÄ Tentative 2 : Proxy Debian ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "üü° Setup proxy Debian"
        if: steps.try_direct.outcome == 'failure'
        env:
          PROXY_DEBIAN_HOST: ${{ secrets.PROXY_DEBIAN_HOST }}
          PROXY_DEBIAN_USER: ${{ secrets.PROXY_DEBIAN_USER }}
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/proxy_debian \
              -D 1080 -N -f \
              $PROXY_DEBIAN_USER@$PROXY_DEBIAN_HOST
          echo "PROXY_URL=socks5://localhost:1080" >> $GITHUB_ENV
          echo "‚úÖ Tunnel SOCKS5 Debian actif"

      - name: "üü° Tentative 2 : Scraping via proxy Debian"
        id: try_debian
        if: steps.try_direct.outcome == 'failure'
        env:
          PUPPETEER_PROXY: ${{ env.PROXY_URL }}
        run: node scraper.js
        continue-on-error: true

      - name: Kill tunnel Debian
        if: steps.try_direct.outcome == 'failure'
        run: pkill -f "ssh.*1080" || true

      # ‚îÄ‚îÄ‚îÄ Tentative 3 : Proxy Windows home ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "üî¥ Setup proxy Windows home"
        if: steps.try_direct.outcome == 'failure' && steps.try_debian.outcome == 'failure'
        env:
          PROXY_WIN_HOST: ${{ secrets.PROXY_WIN_HOST }}
          PROXY_WIN_USER: ${{ secrets.PROXY_WIN_USER }}
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/proxy_win \
              -D 1081 -N -f \
              $PROXY_WIN_USER@$PROXY_WIN_HOST
          echo "PROXY_URL=socks5://localhost:1081" >> $GITHUB_ENV
          echo "‚úÖ Tunnel SOCKS5 Windows home actif"

      - name: "üî¥ Tentative 3 : Scraping via proxy Windows home"
        id: try_win
        if: steps.try_direct.outcome == 'failure' && steps.try_debian.outcome == 'failure'
        env:
          PUPPETEER_PROXY: ${{ env.PROXY_URL }}
        run: node scraper.js
        continue-on-error: true

      - name: Kill tunnel Windows
        if: steps.try_direct.outcome == 'failure' && steps.try_debian.outcome == 'failure'
        run: pkill -f "ssh.*1081" || true

      # ‚îÄ‚îÄ‚îÄ √âchec global ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "üíÄ Toutes les tentatives ont √©chou√©"
        if: >
          steps.try_direct.outcome == 'failure' &&
          (steps.try_debian.outcome == 'failure' || steps.try_debian.outcome == 'skipped') &&
          (steps.try_win.outcome == 'failure' || steps.try_win.outcome == 'skipped')
        run: |
          echo "‚ùå Les 3 proxies ont √©chou√©. Cloudflare bloque tout."
          exit 1

      # ‚îÄ‚îÄ‚îÄ Commit si au moins une tentative a r√©ussi ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Commit results
        if: >
          steps.try_direct.outcome == 'success' ||
          steps.try_debian.outcome == 'success' ||
          steps.try_win.outcome == 'success'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add recteurs.json history.json
          git commit -m "Update rectors data" || echo "No changes"
          git push

      - name: Create issue on failure
        if: >
          steps.try_direct.outcome == 'failure' &&
          (steps.try_debian.outcome == 'failure' || steps.try_debian.outcome == 'skipped') &&
          (steps.try_win.outcome == 'failure' || steps.try_win.outcome == 'skipped')
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let errorDetails = '';
            
            try {
              const errors = JSON.parse(fs.readFileSync('scraper-errors.json', 'utf8'));
              errorDetails = `\n\n**${errors.count} acad√©mie(s) en √©chec :**\n` +
                errors.academies.map(a => `- ${a}`).join('\n');
            } catch (e) {
              errorDetails = '\n\nD√©tails des erreurs non disponibles.';
            }
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `‚ùå √âchec du scraping (3 proxies) - ${new Date().toLocaleDateString('fr-FR')}`,
              body: `Le scraping des donn√©es des recteurs a √©chou√© malgr√© les 3 tentatives de proxy.${errorDetails}\n\n**Workflow Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              labels: ['scraper-error', 'automated']
            });
